# 準備リマインド導入計画

## 1. 目的

イベントの準備遅延を早期に検知し、準備者へ適切なタイミングでリマインドを送る。あわせて未対応が続く場合は管理者へエスカレーションして対応を促す。

## 2. 仕様概要

- 対象イベント: `Event.active = Scheduled` かつ `scheduleTime` が存在するもの。
- 対象ユーザー: 準備者 (`preparerId` が設定されている場合)。
- リマインド: イベントの「3日前」18:00（JST）にイベント連絡チャンネル（`config.event_contact_channel_id`）へ投稿し、準備者をメンションする。
- エスカレーション: イベントの「2日前」18:00（JST）に、未完了の場合のみ連絡チャンネル（`config.event_contact_channel_id`）へ注意喚起を投稿。
- 設定やDB記録は不要（完全固定の挙動）。

## 3. 設計詳細

### 3.1 スケジューラ

- 既存の `node-schedule` を利用。
- 毎日 18:00（JST）にジョブを1つ実行。実行時に当日から見て D-3（リマインド）と D-2（エスカレーション）の対象イベントを抽出して送信。
- Bot再起動時は起動時にジョブを再登録。

### 3.2 重複送信防止

- DB記録は行わない。
- 毎日18時の単発ジョブで「当日がちょうど D-3/D-2」のイベントのみを抽出して送る設計とし、重複送信は発生しない。

### 3.3 メッセージ仕様

- 本文（共通）
  - `「<イベント名>」(ID: <数値>, 日付: <t:UNIX:D>) の準備状況が未完了です。` を基本フォーマットにする。
  - ユーザー名表記はメンションを使用せず表示名（`member.displayName` → `username`）。
- リマインド（連絡チャンネル）
  - イベント連絡チャンネルへ投稿し、準備者（該当ユーザー）をメンションする。
  - allowedMentions は必要最小限（該当ユーザーのみ）を許可。
  - 可能であれば準備状況パネルでの操作案内を簡潔に添える（URLは不要）。
- エスカレーション（連絡チャンネル）
  - `allowedMentions: { users: [] }` を指定し、メンション禁止。

### 3.4 準備完了操作

- DMにはボタンを付けない（簡素化）。
- 準備者はサーバー内の「準備状況パネル」にある「準備完了報告をする」ボタンから実施（既実装機能を利用）。

### 3.5 エスカレーション（管理者通知）

- 2日前18:00に `prepareStatus = false` のイベントに対して、連絡チャンネルへ注意喚起を投稿。
- ロールやユーザーのメンションは行わない（完全にテキストのみ）。
- メッセージ例:
  - `管理者各位: 「<イベント名>」(ID: <数値>, 日付: <t:UNIX:D>) の準備が未完了です。ご確認ください。`

### 3.6 フォールバック

- 行わない。DM送信に失敗した場合は送信しない。

### 3.7 ログと可観測性

- `loggerSchedule` にリマインド送信可否、対象数、失敗理由を出力。

## 4. 実装タスク

1. スケジューラ実装
   - 起動時に毎日 18:00 のジョブを登録。
   - 当日基準で D-3（連絡チャンネル・準備者メンション）/D-2（連絡チャンネル）を抽出し送信。
2. 通知処理
   - 3日前は準備者をメンション（該当ユーザーのみを allowedMentions で許可）。
   - 2日前はメンション不要。
   - いずれも文面に イベントID と `<t:...:D>` 日付を含める（URLは不要）。
3. メッセージテンプレート
   - 文面を小さくシンプルに維持（ID・日付のみ）。
4. テスト・検証
   - 擬似日時でジョブを実行できるヘルパー関数を用意し、ローカルで動作確認。

## 5. メッセージ例

- 準備者向け（連絡チャンネル・メンションあり）
  - `<@123456789012345678> さん、「金曜イベント」(ID: 123, 日付: <t:1727001600:D>) の準備状況が未完了です。準備状況パネルから報告してください。`
- エスカレーション（管理者ロール宛）
  - `管理者各位: 「金曜イベント」(ID: 123, 日付: <t:1727001600:D>) の準備が未完了です。対応をご確認ください。`

## 6. 補足・留意点

- タイムゾーンは JST 固定（必要なら設定化）。
- イベントに準備者が未設定（`preparerId = null`）の場合はリマインド・エスカレーション対象外。
- `prepareStatus = true` のイベントはリマインド対象外。
- 送信失敗時はログのみに留め、再送は翌日の定期ジョブに任せる。
