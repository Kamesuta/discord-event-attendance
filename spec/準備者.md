# 準備者ロール導入計画

## 1. 目的

主催者とは別に、イベントの準備や運営を手伝える「準備者」を導入する。
「準備者」は主催者とほぼ同等のイベント操作権限を持つ。
`/event_creator setup`コマンドで、主催者の設定と同時に「準備者」も設定できるようにする。

## 2. データベース (DB) の変更

既存の `Event` モデルに、準備者のユーザーIDを保存する `preparerId` カラム (`Int?`型) を追加する。
`User` モデルとのリレーションも設定する。リレーション名の衝突を避けるため、既存の `host` リレーションにも明示的に名前を付ける。

```prisma
// prisma/schema.prisma

model Event {
  id Int @id @default(autoincrement())

  // ... (既存のカラム)
  hostId      Int?
  preparerId  Int? // 追加

  // ... (既存のカラム)
  host        User? @relation("EventToHost", fields: [hostId], references: [id])
  preparer    User? @relation("EventToPreparer", fields: [preparerId], references: [id]) // 追加
}

model User {
  id              Int      @id @default(autoincrement())
  // ... (既存のカラム)

  // 関連
  // ... (既存のリレーション)
  hostedEvents    Event[] @relation("EventToHost")
  preparedEvents  Event[] @relation("EventToPreparer") // 追加
}
```

その後、マイグレーションを実行してデータベーススキーマを更新する。

```sh
npx prisma migrate dev --name add-preparer-id-to-event
```

## 3. `/event_creator setup` コマンドの修正

`src/commands/eventCreatorCommand/EventCreatorSetupCommand.ts` を修正し、「準備者」を設定するUIを追加する。

- **UIの追加**:
    - 主催者を選択する `UserSelectMenu` とは別に、「準備者」を設定するための `UserSelectMenu` をもう一つパネルに追加する。
- **表示の更新**:
    - セットアップパネルのEmbedに、現在設定されている「主催者」と「準備者」の両方のユーザー名を表示する。
- **インタラクション処理**:
    - 「準備者」用の `UserSelectMenu` でユーザーが選択された際に、対象イベントの `preparerId` をデータベースで更新する。

## 4. 実装タスク一覧

1.  `prisma/schema.prisma` の `Event` モデルと `User` モデルを修正する。
2.  Prismaマイグレーションを実行する。
3.  `EventCreatorSetupCommand.ts` を修正し、「準備者」を選択するユーザー選択メニューと現在の設定表示を追加する。
4.  `UserSelectMenu` のインタラクションを処理するロジックを修正・追加し、`preparerId` のDB更新ロジックを実装する。

## 6. 将来的なTODO

- **準備リマインド機能**
    - イベント開始の4日前と3日前に、準備者へリマインド通知を送信する。
    - 定期的に実行されるタスクスケジューラが必要になる。
- **準備完了ステータス**
    - `Event` モデルに `prepareStatus` のような真偽値のステータスを追加する。
    - リマインド通知に「準備完了」ボタンを設置し、押されるとこのステータスが `true` になるようにする。
- **管理者へのエスカレーション**
    - リマインド送信時点で `prepareStatus` が `false` の場合、イベント管理者（例: `/event_admin` 権限を持つロール）にメンションを送り、対応を促すメッセージを送信する。
