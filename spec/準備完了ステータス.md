# 準備完了ステータス導入計画

## 1. 目的

イベントの準備状況を可視化し、準備者による準備完了の報告、および管理者による未完了イベントの把握を容易にする。

## 2. データベース (DB) の変更

既存の `Event` モデルに、準備状況を示す `prepareStatus` カラム (`Boolean`型) を追加する。
デフォルト値は `false` とする。

```prisma
// prisma/schema.prisma

model Event {
  id Int @id @default(autoincrement())

  // ... (既存のカラム)
  prepareStatus Boolean @default(false) // 追加
  // ... (既存のカラム)
}
```

その後、マイグレーションを実行してデータベーススキーマを更新する。

```sh
npx prisma migrate dev --name add-prepare-status-to-event
```

## 3. `/event_creator schedule` コマンドの修正

`src/commands/event_creator_command/EventCreatorScheduleCommand.ts` を修正し、以下の機能を追加する。

- **`show` パラメータによる制御**:
    - 既存の `show` という `Boolean` 型のオプションパラメータを使用する。
    - `show` が `true` の場合にのみ、以下のパネル操作（既存パネルの削除と新しいパネルの作成・送信）を実行する。
- **既存パネルの削除**:
    - コマンド実行時に、`config.event_panel_channel_id` に存在する過去の準備状況パネルメッセージを検索し、削除する。
    - パネルメッセージの特定には、メッセージの内容やEmbedのタイトルなどを利用する。
- **新しい準備状況パネルの作成と送信**:
    - 新しい準備状況パネルを作成し、`config.event_panel_channel_id` に送信する。
    - パネルメッセージのIDをDBに保存する必要があるかもしれない（後続の「準備完了ボタン」の実装で必要になる可能性）。
    - `src/message_updaters/` に `PreparationStatusMessageUpdater` クラスを追加し、これを使用してパネルを表示する。

## 4. 準備状況パネルのUI/ロジック

準備状況パネルは、以下の情報を表示する。

- **イベントリスト**:
    - `/event_creator setup` コマンドと同様に、スケジュールされたイベントの一覧を表示する。
- **準備者**:
    - 各イベントに設定された準備者を表示する。
- **準備状況**:
    - `Event` モデルの `prepareStatus` に基づいて、「準備完了」または「未完了」を表示する。
    - 準備者が設定されていないイベントについては、「準備不要」と表示する。

## 5. 実装タスク一覧

1.  `prisma/schema.prisma` の `Event` モデルに `prepareStatus` カラムを追加する。
2.  Prismaマイグレーションを実行する。
3.  `src/commands/event_creator_command/EventCreatorScheduleCommand.ts` を修正し、`show` パラメータによる制御、既存パネルの削除と新しいパネルの作成・送信ロジックを実装する。（`config.event_panel_channel_id` を使用）
4.  準備状況パネルの表示ロジックを実装する（新しい `Action` または `MessageUpdater` を作成する可能性）。

## 6. 準備完了報告機能

準備者が自身の担当するイベントの準備が完了したことを報告するための機能。

-   **UI**:
    -   準備状況パネルの下部に「準備完了報告をする」というボタンを設置する。
-   **インタラクション**:
    1.  ユーザーが「準備完了報告をする」ボタンを押す。
    2.  Ephemeral（そのユーザーにしか見えない一時的な）メッセージとして、返信する。
    3.  このメッセージには、プルダウンメニューが含まれる。
    4.  プルダウンメニューには、そのユーザーが準備担当者として設定されているイベントの一覧が表示される。
-   **ロジック**:
    1.  ユーザーがプルダウンから特定のイベントを選択する。
    2.  選択されたイベントの `prepareStatus` が更新される（`true` なら `false` に、`false` なら `true` に変更されるトグル動作）。
    3.  `prepareStatus` の変更後、準備状況パネルの表示が自動的に更新され、最新の状態が反映される。
    4.  プルダウンメニューに表示されるイベントリストは、ユーザーの権限によって変動する。
        -   `await checkCommandPermission('event_creator', member)` が `true` を返すユーザー（`event_creator`権限保持者）の場合、リストに全てのイベントが表示される。
        -   それ以外のユーザーの場合、自身が準備担当者に設定されているイベントのみがリストに表示される。
