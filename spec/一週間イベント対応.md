# テキストイベント対応計画

## 1. 目的

現在VCイベント（ボイスチャンネルイベント）のみ対応しているイベントBOTを拡張し、**テキストイベント**（テキストチャット・マイクラなどで進行するイベント）にも対応できるようにする。

## 2. 基本方針

**VCイベントとテキストイベントは基本的に同じ扱い**:
- DB構造は変更なし
- 既存のコマンド（`/event review` など）はそのまま使用
- VCイベント特有の機能（VoiceLog自動記録、10分以上の自動判定）が使えないだけ

**違い**:
- **VCイベント**: VoiceLogで自動参加記録、`/event review` で10分以上いる人が自動で候補に表示
- **テキストイベント**: VoiceLogなし、`/event review` で手動で参加者を記録

**注意**: 終了したイベントはDiscordから消えるため、イベントタイプの判定はできない（判定ユーティリティは不要）

## 3. 設定ファイルの変更

### 3.1. `config.toml` への設定追加

```toml
# テキストイベント用のデフォルトチャンネルID
text_event_channel_id = "1234567890123456789"
```

### 3.2. `config.ts` への型定義追加

```typescript
export interface Config {
  // ... (既存の設定)

  /** テキストイベント用チャンネルID */
  text_event_channel_id: string;
}
```

バリデーションも追加:
```typescript
assert(
  config.text_event_channel_id &&
    typeof config.text_event_channel_id === 'string',
  'text_event_channel_id is required and must be a string.',
);
```

## 4. `/event_creator create` コマンドの拡張

`src/commands/event_creator_command/EventCreatorCreateCommand.ts` を修正:

- **オプション引数の追加**:
  - `channel` (Channel): イベントのチャンネル（省略時はコピー元からコピー）
  - 例: `/event_creator create search:マイクラ date:土曜 host:@user channel:#マイクラ部屋`

- **チャンネル種類による自動判定**:
  - **VCチャンネル**: `entityType: Voice`, `channel` をVCとして設定、`channelId` に保存
  - **ステージチャンネル**: `entityType: StageInstance`, `channel` をステージとして設定、`channelId` に保存
  - **テキストチャンネル**: `entityType: External`, `entityMetadata.location` にチャンネル名を設定、`channelId` には `config.text_event_channel_id` を保存
  - **省略時**: コピー元イベントの `channelId` を使用

## 5. `event_handler.ts` の修正

`src/event_handler.ts` の `onCreateScheduledEvent` と `onStartScheduledEvent`:

現在はVCイベントのみチェックしているが、外部イベント（`entityType === External`）も受け入れるように修正:

```typescript
// VCチェックを削除または緩和
// 外部イベントの場合はconfigのチャンネルIDを使用
const channelId = scheduledEvent.channel?.id ?? config.text_event_channel_id;
```

## 6. 実装タスク一覧

### Phase 1: 設定の追加
1. `config.toml` に `text_event_channel_id` を追加
2. `config.ts` に型定義とバリデーションを追加

### Phase 2: イベント作成の拡張
3. `/event_creator create` に `channel` オプション引数を追加（Channel型、任意）
4. チャンネル種類による分岐処理を実装:
   - VCチャンネル → `EntityType.Voice`, `channelId` に保存
   - ステージチャンネル → `EntityType.StageInstance`, `channelId` に保存
   - テキストチャンネル → `EntityType.External` + `entityMetadata.location` にチャンネル名, `channelId` には `config.text_event_channel_id`
   - 省略時 → コピー元の `channelId` を使用

### Phase 3: イベントハンドラーの修正
5. `event_handler.ts` の `onCreateScheduledEvent` を修正
   - VCチェック（`if (!scheduledEvent.channel?.isVoiceBased())`）を削除または緩和
   - 外部イベント（`entityType === External`）も受け入れる
   - `channelId` は `scheduledEvent.channel?.id ?? config.text_event_channel_id`
6. `event_handler.ts` の `onStartScheduledEvent` も同様に修正

## 7. 実装上の注意点

- テキストチャンネルの場合は `EntityType.External` として作成し、`entityMetadata.location` にチャンネル名を設定
- 外部イベントの `channelId` には **必ず `config.text_event_channel_id` を使用**（ダミー値やランダムな文字列は使わない）
- VoiceLogは自動的に記録されない（VCイベントのみ記録される）
